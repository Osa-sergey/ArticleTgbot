# Article-tgbot

## Для чего создано

Приложение представляет из себя Telegram бота для рассылки таргетированных вакансий 
студентам вузов. Бот поддерживает две основные роли: администратор (сотрудник центра карьеры)
 публикующий вакансии от партнеров вуза, студент вуза, который хочет получать актуальную информацию 
о стажировках и предложениях в сфере его рабочей деятельности или интересов. Для того, чтобы 
определить какие вакансии подходят каждому конкретному пользователю на пост при публикации 
навешиваются теги, соответствующие тематике вакансии. Если хотя бы один тег у поста совпадает с тегами, 
выбранными студентом, то данный пост с вакансией показывается студенту.

## Основные возможности

- Рассылка постов всем студентам в независимости от их выбранных тегов при помощи указания для статьи 
тега из переменной `TAG_FOR_ALL_STUDENTS`.
- Выбор нескольких тегов в каждой категории.
- Автоматическое формирование клавиатуры с тегами на основе данных из бд.
- Возможность редактирования поста до момента его публикации.
- Проверка наличия тегов у публикуемого поста и предупреждение в случае их отсутствия.
- Возможность публиковать как текстовые посты при помощи команды `/text `, так и посты с картинками.
- При смене выбранных студентом тегов отображаются подходящие посты за 3 последних месяца.
- Редактирование и публикация постов идет независимо для каждого из администраторов.

## Как запустить

> Note: Для любого из способов. Чтобы комады в боте отображались в меню пользователя необходимо внести
настроить их в BotFather. Список команд:
> - `tags`
> - `student_number`
> - `start`
> - `help`

### Docker
#### Образ и сборка

Для того, чтобы воспользоваться ботом можно использовать готовый docker образ из репозитория:

```sh
    docker pull osasergey/article_tgbot
```

Минимальная конфигурация для запуска в docker-compose выглядит следующим образом:

```sh
  version: '3.1'
services:
  db:
    image: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=1234
      - POSTGRES_DB=hr_center
    volumes:
      - db_volume:/var/lib/postgresql/data
      - ./db.sql:/docker-entrypoint-initdb.d/db.sql


  article_bot:
    image: osasergey/article_tgbot
    ports:
      - "8080:8080"
    environment:
      - BOT_TOKEN=
      - DB_USER=postgres
      - DB_PASSWORD=1234
      - DB_HOST=db
      - DB_NAME=hr_center
      - TAG_FOR_ALL_STUDENTS=Разослать всем
    volumes:
      - ./res:/app/article_tgbot/res

volumes:
  db_volume:
```

для запуска:

```sh
docker compose up
```

#### Переменные окружения 

Все переменные должны быть `ОБЯЗАТЕЛЬНО` заполнены

- `BOT_TOKEN` - Токен TelegramAPI получаемый у BotFather.
- `DB_USER` - Имя пользователя базы данных.
- `DB_PASSWORD` - Пароль пользователя базы данных.
- `DB_HOST` - Host базы данных.
- `DB_NAME` - Название базы данных.
- `TAG_FOR_ALL_STUDENTS` - Название тега для рассылки поста всем студентам.
---
> Note: `DB_PORT`=5433 и не является переменной, которую можно изменять извне.
> Предполагается, что она будет использоваться только с dev окружением `dev_env.yaml`.
> Основной способ использования бота - контейнер в оркестраторе. Про dev окружение 
> смотрите ниже.
#### Volumes

В файле `db.sql` размещен скрипт инициализации базы данных и создания всех необходимых функций 
и триггеров.
---
Для корректной работы необходимо составить несколько файлов конфигурации:

- `res/new_admins.yaml` Представляет из себя список telegramID администраторов бота.
Нужен для разграничения доступа.  
- `res/new_tags.yaml` Представляет из себя список категорий и соответсвующих им тегов.
Формирует клавиатуру для маркировки постов и выбора подходящих тегов студентами.

Оба файла применяются при каждом старте бота, что дает возможность добавлять данные в списки
администраторов и теги. 
Примеры данных файлов можно найти в репозитории по пути `article_tgbot/res`.

### Руками 

Для запуска руками необходимо выполнить команду:

```sh
pip install -r article_tgbot/requirements.txt 
```
После чего прописать переменные окружения в `article_tgbot/src/settings/settings.py`.
Подробнее о переменных окружения смотрите выше. Потом заполните файлы в `article_tgbot/res`
в соответствии с вашими данными. Конфигурация dev окружения находится в `dev_env.yaml`.
Для PyCharm можно импортировать конфигурацию запуска из папки `dev.run` или запустить ее 
командой: 
```sh
docker compose up -f dev_env.yaml
```
Далее можно запускать бота:
```sh
python article_tgbot/src/bot.py
```